# ğŸ” æ ¸å¿ƒç±»ä»£ç æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ—¶é—´
2024å¹´ï¼ˆå½“å‰æ£€æŸ¥ï¼‰

## ğŸ“Š æ£€æŸ¥èŒƒå›´
- Ability / AbilityManagerï¼ˆèƒ½åŠ›ç³»ç»Ÿï¼‰
- Playerï¼ˆç©å®¶ï¼‰
- Enemyï¼ˆæ•Œäººï¼‰
- GameManagerï¼ˆæ¸¸æˆç®¡ç†å™¨ï¼‰
- StorageManagerï¼ˆå­˜æ¡£ç³»ç»Ÿï¼‰

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆéœ€è¦ç«‹å³ä¿®å¤ï¼‰

### é—®é¢˜1ï¼šAbilityManager æ„é€ å‡½æ•°ç¼ºå°‘ç©ºæŒ‡é’ˆæ£€æŸ¥

**ä½ç½®**ï¼š`core/src/de/tum/cit/fop/maze/abilities/AbilityManager.java:19-33`

**é—®é¢˜æè¿°**ï¼š
```java
public AbilityManager(Player player, GameManager gameManager) {
    this.player = player;
    this.gameManager = gameManager;
    initializeAbilities(); // âŒ å¦‚æœ player ä¸º nullï¼Œè¿™é‡Œä¼šå´©æºƒ
}

private void initializeAbilities() {
    if (player.getPlayerIndex() == Player.PlayerIndex.P1) { // âŒ player å¯èƒ½ä¸º null
        // ...
    }
}
```

**é—®é¢˜**ï¼š
- âŒ æ„é€ å‡½æ•°ä¸­æ²¡æœ‰æ£€æŸ¥ `player` å’Œ `gameManager` æ˜¯å¦ä¸º null
- âŒ `initializeAbilities()` ä¸­ç›´æ¥è°ƒç”¨ `player.getPlayerIndex()`ï¼Œå¦‚æœ player ä¸º null ä¼šæŠ›å‡º `NullPointerException`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```java
public AbilityManager(Player player, GameManager gameManager) {
    if (player == null) {
        throw new IllegalArgumentException("Player cannot be null");
    }
    if (gameManager == null) {
        throw new IllegalArgumentException("GameManager cannot be null");
    }
    this.player = player;
    this.gameManager = gameManager;
    initializeAbilities();
}
```

---

### é—®é¢˜2ï¼šAbilityManager.drawAbilities() ç¼ºå°‘å‚æ•°éªŒè¯

**ä½ç½®**ï¼š`core/src/de/tum/cit/fop/maze/abilities/AbilityManager.java:88-92`

**é—®é¢˜æè¿°**ï¼š
```java
public void drawAbilities(SpriteBatch batch, ShapeRenderer sr, Player player) {
    for (Ability ability : abilities.values()) {
        ability.draw(batch, sr, player); // âŒ å‚æ•°å¯èƒ½ä¸º null
    }
}
```

**é—®é¢˜**ï¼š
- âŒ `batch`ã€`sr`ã€`player` å‚æ•°å¯èƒ½ä¸º nullï¼Œæ²¡æœ‰éªŒè¯
- âŒ å¦‚æœä¼ å…¥ null ä¼šæŠ›å‡º `NullPointerException`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```java
public void drawAbilities(SpriteBatch batch, ShapeRenderer sr, Player player) {
    if (batch == null || sr == null || player == null) {
        Logger.warning("drawAbilities called with null parameters");
        return;
    }
    for (Ability ability : abilities.values()) {
        ability.draw(batch, sr, player);
    }
}
```

---

### é—®é¢˜3ï¼šPlayer.onPushedBy() ç¼ºå°‘ç©ºæŒ‡é’ˆæ£€æŸ¥

**ä½ç½®**ï¼š`core/src/de/tum/cit/fop/maze/entities/Player.java:423-435`

**é—®é¢˜æè¿°**ï¼š
```java
public boolean onPushedBy(PushSource source, int dx, int dy, GameManager gm) {
    int strength = source.getPushStrength(); // âŒ source å¯èƒ½ä¸º null
    int targetX = x + dx * strength;
    int targetY = y + dy * strength;
    
    if (!gm.canPlayerMoveTo(targetX, targetY)) { // âŒ gm å¯èƒ½ä¸º null
        takeDamage(1);
        return false;
    }
    // ...
}
```

**é—®é¢˜**ï¼š
- âŒ `source` å’Œ `gm` å‚æ•°æ²¡æœ‰ç©ºæŒ‡é’ˆæ£€æŸ¥
- âŒ å¦‚æœä¼ å…¥ null ä¼šæŠ›å‡º `NullPointerException`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```java
public boolean onPushedBy(PushSource source, int dx, int dy, GameManager gm) {
    if (source == null || gm == null) {
        Logger.warning("onPushedBy called with null parameters");
        return false;
    }
    int strength = source.getPushStrength();
    // ... åŸæœ‰é€»è¾‘
}
```

---

### é—®é¢˜4ï¼šGameManager.restorePlayers() ç¼ºå°‘ç©ºå€¼æ£€æŸ¥

**ä½ç½®**ï¼š`core/src/de/tum/cit/fop/maze/game/GameManager.java:1510-1530`

**é—®é¢˜æè¿°**ï¼š
```java
for (Player p : players) {
    PlayerSaveData ps = saveData.players.get(p.getPlayerIndex().name());
    // âŒ å¦‚æœ players åˆ—è¡¨ä¸­æœ‰ null å…ƒç´ ï¼Œp.getPlayerIndex() ä¼šå´©æºƒ
    if (ps == null) continue;
    // ...
}
```

**é—®é¢˜**ï¼š
- âŒ å¾ªç¯ä¸­æ²¡æœ‰æ£€æŸ¥ `p` æ˜¯å¦ä¸º null
- âŒ å¦‚æœåˆ—è¡¨ä¸­æœ‰ null å…ƒç´ ï¼Œ`p.getPlayerIndex()` ä¼šæŠ›å‡º `NullPointerException`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```java
for (Player p : players) {
    if (p == null) continue; // æ·»åŠ ç©ºå€¼æ£€æŸ¥
    PlayerSaveData ps = saveData.players.get(p.getPlayerIndex().name());
    if (ps == null) continue;
    // ... åŸæœ‰é€»è¾‘
}
```

---

### é—®é¢˜5ï¼šAbility.loadState() ç±»å‹è½¬æ¢ä¸å®‰å…¨

**ä½ç½®**ï¼š`core/src/de/tum/cit/fop/maze/abilities/Ability.java:188-196`

**é—®é¢˜æè¿°**ï¼š
```java
public void loadState(Map<String, Object> m) {
    if (m == null) return;
    
    level = (int) m.getOrDefault("level", level); // âš ï¸ ç±»å‹è½¬æ¢ä¸å®‰å…¨
    ready = (boolean) m.getOrDefault("ready", true); // âš ï¸ ç±»å‹è½¬æ¢ä¸å®‰å…¨
    active = (boolean) m.getOrDefault("active", false); // âš ï¸ ç±»å‹è½¬æ¢ä¸å®‰å…¨
    cooldownTimer = ((Number)m.getOrDefault("cooldownTimer", 0f)).floatValue();
    durationTimer = ((Number)m.getOrDefault("durationTimer", 0f)).floatValue();
}
```

**é—®é¢˜**ï¼š
- âš ï¸ ç›´æ¥ç±»å‹è½¬æ¢ï¼Œå¦‚æœç±»å‹ä¸åŒ¹é…ä¼šæŠ›å‡º `ClassCastException`
- âš ï¸ `m.getOrDefault()` è¿”å›çš„æ˜¯ `Object`ï¼Œéœ€è¦å®‰å…¨çš„ç±»å‹è½¬æ¢

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```java
public void loadState(Map<String, Object> m) {
    if (m == null) return;
    
    // å®‰å…¨çš„ç±»å‹è½¬æ¢
    Object levelObj = m.get("level");
    if (levelObj instanceof Number) {
        level = ((Number) levelObj).intValue();
    }
    
    Object readyObj = m.get("ready");
    if (readyObj instanceof Boolean) {
        ready = (Boolean) readyObj;
    }
    
    Object activeObj = m.get("active");
    if (activeObj instanceof Boolean) {
        active = (Boolean) activeObj;
    }
    
    Object cooldownObj = m.get("cooldownTimer");
    if (cooldownObj instanceof Number) {
        cooldownTimer = ((Number) cooldownObj).floatValue();
    }
    
    Object durationObj = m.get("durationTimer");
    if (durationObj instanceof Number) {
        durationTimer = ((Number) durationObj).floatValue();
    }
}
```

---

## ğŸŸ¡ ä¸­ç­‰ä¼˜å…ˆçº§é—®é¢˜

### é—®é¢˜6ï¼šStorageManager.loadGameInternal() æ•°æ®éªŒè¯ä¸å®Œå–„

**ä½ç½®**ï¼š`core/src/de/tum/cit/fop/maze/game/save/StorageManager.java:164-190`

**é—®é¢˜æè¿°**ï¼š
```java
private GameSaveData loadGameInternal(String fileName) {
    // ...
    GameSaveData data = json.fromJson(GameSaveData.class, jsonStr);
    return data; // âš ï¸ æ²¡æœ‰éªŒè¯æ•°æ®çš„æœ‰æ•ˆæ€§
}
```

**é—®é¢˜**ï¼š
- âš ï¸ åŠ è½½åçš„æ•°æ®æ²¡æœ‰éªŒè¯ï¼ˆlevel >= 1, score >= 0 ç­‰ï¼‰
- âš ï¸ å¦‚æœæ•°æ®æŸåæˆ–æ— æ•ˆï¼Œå¯èƒ½å¯¼è‡´æ¸¸æˆå¼‚å¸¸

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```java
private GameSaveData loadGameInternal(String fileName) {
    // ... åŸæœ‰åŠ è½½é€»è¾‘ ...
    GameSaveData data = json.fromJson(GameSaveData.class, jsonStr);
    
    // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
    if (data != null) {
        if (data.currentLevel < 1) {
            Logger.warning("Invalid level in save: " + data.currentLevel + ", setting to 1");
            data.currentLevel = 1;
        }
        if (data.score < 0) {
            Logger.warning("Invalid score in save: " + data.score + ", setting to 0");
            data.score = 0;
        }
    }
    
    return data;
}
```

---

### é—®é¢˜7ï¼šAbilityManager.equipAbility() å¯èƒ½è®¾ç½® null

**ä½ç½®**ï¼š`core/src/de/tum/cit/fop/maze/abilities/AbilityManager.java:76-79`

**é—®é¢˜æè¿°**ï¼š
```java
public void equipAbility(String abilityId, int slot) {
    if (slot < 0 || slot >= abilitySlots.length) return;
    abilitySlots[slot] = abilities.get(abilityId); // âš ï¸ å¯èƒ½è®¾ç½®ä¸º null
}
```

**é—®é¢˜**ï¼š
- âš ï¸ å¦‚æœ `abilityId` ä¸å­˜åœ¨ï¼Œ`abilities.get()` è¿”å› nullï¼Œä¼šå°† slot è®¾ç½®ä¸º null
- âš ï¸ åç»­è°ƒç”¨ `activateSlot()` æ—¶ä¼šå¤±è´¥ï¼Œä½†æ²¡æœ‰è­¦å‘Š

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```java
public void equipAbility(String abilityId, int slot) {
    if (slot < 0 || slot >= abilitySlots.length) return;
    Ability ability = abilities.get(abilityId);
    if (ability == null) {
        Logger.warning("Cannot equip ability: " + abilityId + " not found");
        return;
    }
    abilitySlots[slot] = ability;
}
```

---

## ğŸ“Š é—®é¢˜ç»Ÿè®¡

| ä¸¥é‡ç¨‹åº¦ | æ•°é‡ | çŠ¶æ€ |
|---------|------|------|
| ğŸ”´ ä¸¥é‡ | 5 | éœ€è¦ç«‹å³ä¿®å¤ |
| ğŸŸ¡ ä¸­ç­‰ | 2 | å»ºè®®å°½å¿«ä¿®å¤ |

---

## ğŸ¯ ä¿®å¤ä¼˜å…ˆçº§

### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰
1. âœ… **é—®é¢˜1**ï¼šAbilityManager æ„é€ å‡½æ•°ç©ºæŒ‡é’ˆæ£€æŸ¥
2. âœ… **é—®é¢˜2**ï¼šAbilityManager.drawAbilities() å‚æ•°éªŒè¯
3. âœ… **é—®é¢˜3**ï¼šPlayer.onPushedBy() ç©ºæŒ‡é’ˆæ£€æŸ¥
4. âœ… **é—®é¢˜4**ï¼šGameManager.restorePlayers() ç©ºå€¼æ£€æŸ¥
5. âœ… **é—®é¢˜5**ï¼šAbility.loadState() ç±»å‹è½¬æ¢å®‰å…¨

### ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆå°½å¿«ä¿®å¤ï¼‰
6. âœ… **é—®é¢˜6**ï¼šStorageManager æ•°æ®éªŒè¯
7. âœ… **é—®é¢˜7**ï¼šAbilityManager.equipAbility() ç©ºå€¼æ£€æŸ¥

---

*æœ¬æŠ¥å‘ŠåŸºäºé™æ€ä»£ç åˆ†æï¼Œå®é™…è¿è¡Œæ—¶å¯èƒ½éœ€è¦æ ¹æ®å…·ä½“æƒ…å†µè°ƒæ•´ã€‚*
