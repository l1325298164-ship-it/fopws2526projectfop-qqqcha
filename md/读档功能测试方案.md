# 🧪 读档功能测试方案

## 📋 测试目标

验证修复后的读档功能是否能够：
1. ✅ 正确恢复关卡等级（currentLevel）
2. ✅ 正确恢复玩家状态（生命值、魔法、Buff等）
3. ✅ 正确恢复分数
4. ✅ 正确恢复难度配置
5. ✅ 读档后生成对应关卡的新随机迷宫

---

## 🎮 测试步骤

### 测试1：基础读档测试

#### 步骤：
1. **启动游戏**
   - 运行游戏，进入主菜单

2. **开始新游戏**
   - 点击 "START GAME" 或 "NEW GAME"
   - 进入第1关

3. **等待自动保存**
   - 在游戏中等待30秒（自动保存间隔）
   - 或直接完成第1关（关卡结束会自动保存）

4. **返回主菜单**
   - 按 ESC 键（或对应按键）暂停
   - 点击 "MENU" 返回主菜单

5. **读档测试**
   - 主菜单应该显示 "CONTINUE" 按钮（如果存在存档）
   - 点击 "CONTINUE"
   - 游戏应该恢复到第1关（或之前保存的关卡）

6. **验证恢复状态**
   - ✅ 检查关卡数是否正确（屏幕左上角应该显示正确的关卡数）
   - ✅ 检查玩家生命值是否恢复
   - ✅ 检查分数是否恢复（屏幕顶部应该显示正确的分数）
   - ✅ 检查迷宫是否重新生成（应该是一个新的随机迷宫）

---

### 测试2：跨关卡存档测试

#### 步骤：
1. **开始新游戏并完成第1关**
   - 进入游戏，完成第1关
   - 在结算界面选择"下一关"（会进入第2关并保存）

2. **验证存档内容**
   - 在第2关中，按 ESC 暂停
   - 点击 "MENU" 返回主菜单

3. **读档测试**
   - 点击 "CONTINUE"
   - 应该进入第2关（不是第1关）

4. **验证关卡恢复**
   - ✅ 检查关卡显示是否为第2关
   - ✅ 检查分数是否累计（应该包含第1关的分数）
   - ✅ 检查新迷宫是否生成（第2关的新随机迷宫）

---

### 测试3：难度恢复测试

#### 步骤：
1. **使用不同难度开始游戏**
   - 在主菜单点击 "DIFFICULTY"
   - 选择 "HARD" 难度
   - 开始游戏并等待自动保存（或完成关卡）

2. **读档测试**
   - 返回主菜单
   - 点击 "CONTINUE"
   - 应该恢复到 "HARD" 难度

3. **验证难度恢复**
   - ✅ 检查敌人数量是否符合 HARD 难度
   - ✅ 检查迷宫大小是否符合 HARD 难度配置

---

### 测试4：玩家状态恢复测试

#### 步骤：
1. **修改玩家状态**
   - 在游戏中获取一些道具（如生命包、Buff等）
   - 或使用开发者控制台（如果可用）：
     - 按 `~` 键打开控制台（如果启用）
     - 输入命令修改玩家状态

2. **保存并读档**
   - 等待自动保存或返回菜单再读档
   - 点击 "CONTINUE"

3. **验证状态恢复**
   - ✅ 检查生命值是否恢复
   - ✅ 检查魔法值是否恢复
   - ✅ 检查Buff状态是否恢复（如果有）
   - ✅ 检查钥匙状态是否恢复（如果有钥匙）

---

### 测试5：分数恢复测试

#### 步骤：
1. **获得分数**
   - 在游戏中击杀敌人获得分数
   - 完成第1关，进入结算界面查看分数

2. **保存并读档**
   - 选择"下一关"，进入第2关（会自动保存）
   - 返回主菜单，点击 "CONTINUE"

3. **验证分数恢复**
   - ✅ 检查分数是否正确恢复
   - ✅ 检查分数是否累计（包含之前关卡的分数）

---

### 测试6：无存档读档测试

#### 步骤：
1. **删除存档**
   - 如果存在存档文件，手动删除 `save_data.json.gz` 或 `save_data.json`

2. **尝试读档**
   - 启动游戏
   - 如果主菜单显示 "CONTINUE"，点击它
   - 应该降级处理，开始新游戏（而不是崩溃）

3. **验证降级处理**
   - ✅ 游戏应该正常开始新游戏
   - ✅ 不应该崩溃或出现错误

---

## 🔍 验证要点

### 必须验证的项目：

1. **关卡等级恢复**
   - [ ] 读档后关卡数正确
   - [ ] 如果是第3关存档，读档后应该进入第3关

2. **迷宫生成**
   - [ ] 读档后生成新的随机迷宫
   - [ ] 迷宫布局与存档前不同（因为是随机生成的）

3. **玩家状态恢复**
   - [ ] 生命值正确恢复
   - [ ] 魔法值正确恢复
   - [ ] Buff状态正确恢复

4. **分数恢复**
   - [ ] 总分正确恢复
   - [ ] 分数累计正确（多关卡情况）

5. **难度恢复**
   - [ ] 难度配置正确恢复
   - [ ] 敌人数量符合难度配置

6. **错误处理**
   - [ ] 无存档时正确处理（不崩溃）
   - [ ] 损坏存档时正确处理（不崩溃）

---

## 🐛 已知问题检查

### 修复前的问题（应已修复）：
- ✅ 读档后关卡不正确 → **应已修复**
- ✅ 迷宫生成错误 → **应已修复**

### 修复后的预期行为：
- ✅ 读档后正确恢复关卡等级
- ✅ 读档后生成对应关卡的新随机迷宫
- ✅ 玩家状态正确恢复

---

## 📝 测试检查清单

### 基础功能测试
- [ ] 可以正常保存游戏
- [ ] 可以正常读取存档
- [ ] 读档后关卡等级正确
- [ ] 读档后玩家状态正确

### 边界情况测试
- [ ] 无存档时读档（应该开始新游戏）
- [ ] 损坏存档时读档（应该处理错误）
- [ ] 第1关存档读档
- [ ] 高关卡存档读档（如第5关）

### 状态恢复测试
- [ ] 生命值恢复
- [ ] 魔法值恢复
- [ ] Buff状态恢复
- [ ] 钥匙状态恢复
- [ ] 分数恢复

---

## 🔧 调试方法

### 1. 查看日志输出

在控制台或日志文件中查看以下信息：
```
Loading game... Level: X
Game State Restored: Level X, Score Y
ScoreManager Restored: Total=Y, LevelBase=Z
```

### 2. 检查存档文件

存档文件位置：
- `save_data.json.gz` (压缩格式，新版本)
- `save_data.json` (未压缩格式，旧版本)

可以手动检查存档内容：
```bash
# 如果是压缩格式，先解压
gunzip save_data.json.gz
# 然后查看内容
cat save_data.json
```

### 3. 使用开发者控制台（如果可用）

如果开发者控制台已启用：
- 按 `~` 键打开控制台
- 可以查看当前状态：
  - 关卡数
  - 玩家生命值
  - 分数
  - 等等

---

## 🎯 测试成功标准

### 必须满足：
1. ✅ 读档后关卡等级正确
2. ✅ 读档后生成新的随机迷宫（与存档前不同）
3. ✅ 玩家状态正确恢复
4. ✅ 分数正确恢复
5. ✅ 游戏不会崩溃

### 如果测试失败：

**问题1：读档后关卡不正确**
- 检查日志中的 "Game State Restored: Level X"
- 验证 `restoreState()` 方法是否正确调用

**问题2：迷宫没有重新生成**
- 检查 `restoreState()` 中是否调用了 `resetGame()`
- 验证迷宫布局是否与存档前不同

**问题3：玩家状态未恢复**
- 检查存档文件中的状态数据
- 验证 `restoreState()` 中的恢复逻辑

---

## 📊 测试结果记录

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 基础读档 | ⬜ | |
| 跨关卡存档 | ⬜ | |
| 难度恢复 | ⬜ | |
| 玩家状态恢复 | ⬜ | |
| 分数恢复 | ⬜ | |
| 无存档处理 | ⬜ | |
| 错误处理 | ⬜ | |

---

## 💡 快速测试方法

### 方法1：使用自动保存
1. 开始游戏
2. 等待30秒（自动保存）
3. 返回主菜单
4. 点击 CONTINUE
5. 验证读档是否正确

### 方法2：完成关卡保存
1. 开始游戏
2. 完成第1关
3. 选择"下一关"（会自动保存）
4. 返回主菜单
5. 点击 CONTINUE
6. 验证是否进入第2关

---

## 🔍 可能的问题和解决方案

### 问题：读档后仍然是第1关

**检查**：
- 查看存档文件中的 `currentLevel` 字段
- 检查 `restoreState()` 是否正确恢复 `currentLevel`

**解决**：
- 确保 `restoreState()` 在 `resetGame()` 之前设置了 `currentLevel`
- 虽然 `resetGame()` 不依赖 `currentLevel`，但需要确保值正确

### 问题：迷宫没有重新生成

**检查**：
- 验证 `restoreState()` 中是否调用了 `resetGame()`
- 检查迷宫布局是否真的改变了

**解决**：
- 确保 `restoreState()` 中调用了 `resetGame()`

### 问题：玩家状态未恢复

**检查**：
- 查看存档文件中的数据
- 检查 `restoreState()` 中的恢复逻辑

**解决**：
- 确保在 `resetGame()` 之后重新恢复玩家状态

---

## ✅ 测试完成标准

所有测试项都通过后，读档功能应能：
1. ✅ 正确恢复关卡等级
2. ✅ 正确生成对应关卡的新迷宫
3. ✅ 正确恢复所有玩家状态
4. ✅ 正确处理边界情况
5. ✅ 不出现崩溃或错误
